<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

    <title>Hello, world!</title>
  </head>
  <body>
      <div class="container text-center">
        <div id="root"></div>
      </div>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script
        src="https://code.jquery.com/jquery-3.3.1.min.js"
        integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.5/lodash.min.js"></script>    
    <script src="https://momentjs.com/downloads/moment.js"></script>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script> -->
    <!-- <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script> -->    
    
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    
<script>

var results = [];
var keys = [];

// start
$(document).ready(function(){ 
    getJsonData(function(){ 
        run(); 
    }); 
});



function run(){
    
    $('#root').html();

    draw_title();
    draw_chartPie();
    draw_lineChart_histogram();

    run_strategy_color("green");
    run_strategy_color("black");
    run_strategy_color("red");

    for(var i = 0; i <= 14; i++){
        run_strategy_number(i);
    }
};


function run_strategy_number(number){
    var czy_grac = true;
    var czy_zakonczyc = false;
    
    
    var item_first = results[keys[0]];
    var pierwszy_kolor = item_first.c;

    var kwota_poczatkowa = 1000;
    var bet_poczatkowy = 1;
    var bet_aktualny = 1;
    var bilans = 0;

    var rozegranych_gier = 0;
    var max_rozegranych_gier = 100;

    bilans = kwota_poczatkowa;

    for(var i = 0; i < keys.length; i++){
        var wynik_rundy = results[keys[i]];

        if(czy_grac){
            var czy_wygrana = wynik_rundy.n == number;
            
            bilans += (czy_wygrana ? 1 : -1) * bet_aktualny * 2;
            rozegranych_gier++; 
        }

        if(rozegranych_gier >= max_rozegranych_gier){ czy_zakonczyc = true; }
        if(czy_zakonczyc){ break; }
    }
    console.log('co wyszlo?  rg, kw, ba, b, N: ',  rozegranych_gier, kwota_poczatkowa, bet_aktualny, bilans, number)
}


function run_strategy_color(kolor){
    var czy_grac = true;
    var czy_zakonczyc = false;
    
    
    var item_first = results[keys[0]];
    var pierwszy_kolor = item_first.c;

    var kwota_poczatkowa = 1000;
    var bet_poczatkowy = 1;
    var bet_aktualny = 1;
    var bilans = 0;

    var rozegranych_gier = 0;
    var max_rozegranych_gier = 2000;

    bilans = kwota_poczatkowa;

    for(var i = 0; i < keys.length; i++){
        var wynik_rundy = results[keys[i]];

        if(czy_grac){
            var czy_wygrana = wynik_rundy.c == kolor;
            bilans += (czy_wygrana ? 1 : -1) * bet_aktualny * 2;
            rozegranych_gier++; 
        }

        if(rozegranych_gier >= max_rozegranych_gier){ czy_zakonczyc = true; }
        if(czy_zakonczyc){ break; }
    }
    console.log('co wyszlo?  rg, kw, ba, b, c: ',  rozegranych_gier, kwota_poczatkowa, bet_aktualny, bilans, kolor)
}

function draw_title(){

    var item_first = results[keys[0]];
    var item_last = results[keys[keys.length - 1]];
    var title =  moment(item_first.t).format('YYYY-MM-DD HH:MM') + " - " + moment(item_last.t).format('YYYY-MM-DD HH:MM');
    title += "<br/>(ID:" + item_first.id +'-' + item_last.id + ") ";
    title += "<br> Suma wynikow: " + keys.length; 
    $('#root').append($("<h1>").html(title))
}

function getJsonData(callback){
    var minId = 1235890;
    var maxId = 1237594;
    return $.get('./results.json')
    .done(function (data) {
        results = _.filter(data, function(o) { 
            var id = parseInt(o.id, 10); 
            return id > minId && id < maxId; 
        });

        keys = Object.keys(results);

        callback();
    })
}


function draw_lineChart_histogram(){

    var html__chart_black_vs_red = $('<div id="chart_histogram" style="min-width: 310px; height: 400px; max-width: 600px; margin: 0 auto"></div>');

    $('#root').append(html__chart_black_vs_red);


    var series = [{
        name: "Wypadło razy: ",
        data: []
    }];

    groups = _.chain(results)
        .groupBy(function(a){ return a.n })
        .value()

    _.each(groups, function(key, index){
        series[0].data.push(key.length);
    })
    

    Highcharts.chart('chart_histogram', {
        chart: {
            type: 'line'
        },
        title: {
            text: 'Jak często wystąpiły liczby?'
        },
        xAxis: {
            categories: [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14],
            title: {
                text: 'Numer liczby'
            }
        },
        yAxis: {
            title: {
                text: 'Liczba wystąpień'
            }
        },
        plotOptions: {
            line: {
                dataLabels: {
                    enabled: true
                }
            }
        },
        series: series
    });
}

function draw_chartPie(){

    
    var html__chart_black_vs_red = $('<div id="chart_black_vs_red" style="min-width: 310px; height: 400px; max-width: 600px; margin: 0 auto"></div>');

    $('#root').append(html__chart_black_vs_red);

    

    var item_first = results[keys[0]];
    var item_last = results[keys[keys.length - 1]];

    var count_green = 0;
    var count_red = 0;
    var count_black = 0;

    for(var i = 0; i < keys.length; i++){
        var row = results[keys[i]];
        if(row.c == "green"){ count_green++; }
        if(row.c == "red"){ count_red++; }
        if(row.c == "black"){ count_black++; }
        
    }


    Highcharts.chart('chart_black_vs_red', {
        colors: ['green', 'red', 'black'],
   
        chart: {
            plotBackgroundColor: null,
            plotBorderWidth: null,
            plotShadow: false,
            type: 'pie'
        },
        title: {
            text: 'Co wystąpiło najczęściej?' 
        },
        tooltip: {
            pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
        },
        plotOptions: {
            pie: {
                allowPointSelect: false,
                cursor: 'pointer',
                dataLabels: {
                    enabled: true,
                    format: '<b>{point.name}</b>: {point.percentage:.1f} % - {point.y}',
                    style: {
                        color: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black'
                    }
                }
            }
        },

        credits: {
            enabled: false
        },
        series: [{
            name: 'Wynik',
            colorByPoint: true,
            data: [{
                name: 'zielony',
                y: count_green
            }, {
                name: 'czerwony',
                y: count_red,
                sliced: true,
                selected: true
            }, {
                name: 'czarny',
                y: count_black
            }]
        }]
    });
}

</script>

  </body>
</html>